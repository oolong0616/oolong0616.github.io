---
layout:     post  
title:      3、离线安装部署    
subtitle:   笔记：CDH大数据平台实战指南 
date:       2019-06-25  
author:     岑晨  
header-img: 
catalog: true  
tags:  
    - CDH     
    - 笔记 
---

# 官方参考

https://www.cloudera.com/documentation/enterprise/5-16-x.html

# OS准备

*此功能操作需要在主服务器及从服务器同时执行*

参考：https://oolong0616.github.io/2018/11/19/Centos%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE/

# 资料准备

*此功能操作需要在主服务器及从服务器同时执行*

- Cloudeara Manager：http://archive.cloudera.com/cm5/

  内容：[cloudera-manager-centos7-cm5.16.2_x86_64.tar.gz](http://archive.cloudera.com/cm5/cm/5/cloudera-manager-centos7-cm5.16.2_x86_64.tar.gz)

- CDH：http://archive.cloudera.com/cdh5/parcels/
  
  内容(el7代表centos7)：
  
  - [CDH-5.16.2-1.cdh5.16.2.p0.8-el7.parcel](http://archive.cloudera.com/cdh5/parcels/5.16.2/CDH-5.16.2-1.cdh5.16.2.p0.8-el7.parcel)
  
  - [CDH-5.16.2-1.cdh5.16.2.p0.8-el7.parcel.sha1](http://archive.cloudera.com/cdh5/parcels/5.16.2/CDH-5.16.2-1.cdh5.16.2.p0.8-el7.parcel.sha1) （后缀改为sha）
  
  - [manifest.json](http://archive.cloudera.com/cdh5/parcels/5.16.2/manifest.json)

#  依赖程序安装

*此功能操作需要在主服务器及从服务器同时执行*

## JDK 

参考(必须安装Oracle官方版本)：https://oolong0616.github.io/2018/11/19/Centos%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE/

## MySQL

参考：https://oolong0616.github.io/2018/11/19/Centos%E5%AE%89%E8%A3%85Mysql/

## 其他

```bash
yum install -y chkconfig
yum install -y Python
yum install -y bind-utils
yum install -y psmisc
yum install -y libxslt
yum install -y zlib
yum install -y sqlite
yum install -y cyrus-sasl-plain
yum install -y cyrus-sasl-gssapi
yum install -y fuse
yum install -y portmap
yum install -y fuse-libs
yum install -y redhat-lsb
yum install -y bind-utils
yum install -y libxslt
```

# 配置网络

*此功能操作需要在主服务器及从服务器同时执行*

## 设置主机名

```bash
hostnamectl set-hostname node0.knowersoft.com
hostname
# node0.knowersoft.com
```

##  hosts

- 位置：

  ```bash
  vi /etc/hosts
  ```

- 内容：

  ```bash
  10.10.75.lOO nodeO.knowersoft.com nodeO
  10.10.75.lOO node1.knowersoft.com node1
  10.10.75.lOO node2.knowersoft.com node2
  ```

## 主机名

- 前置设置：

  - 删除 /etc/sysconfig/network-scripts/ 下除`ifcfg-eth0`外所有`ifcfg-eth*`文件
  - 关闭network服务

  ```bash
  systemctl is-enabled network
  ```

- 位置：

  ```bash
  vi /etc/sysconfig/network
  ```

- 内容 

  ```bash
  HOSTNAME=nodeX.knowersoft.com 
  ```

- 设置生效

  ```bash
  systemctl restart network.service # 重启服务
  systemctl status network.service #查看状态
  chkconfig --level 345 network on # 设置开机启动
  chkconfig --list network #查看状态
  ```

- 重启

# 调整参数

*此功能操作需要在主服务器及从服务器同时执行*

- 最大程度使用内存 

  ```bash
  echo 0 >/proc/sys/vm/swappiness
  echo "vm.swappiness＝0">> /etc/sysctl.conf
  echo "echo 0 > /proc/sys/vm/swappiness" >>/etc/rc.d/rc.local
  cat /proc/sys/vm/swappiness
  # 0
  ```

- 禁用hugepage透明页

  ```bash
  echo "echo never > /sys/kernel/mm/transparent_hugepage/enabled" >>/etc/rc.d/rc.local
  echo "echo never > /sys/kernel/mm/redhat_transparent_hugepage/defrag">>/etc/rc.d/rc.local
  ```

- 修改 Linux 最大文件句柄数

  ```bash
  echo "* soft nofile 128000" >>/etc/security/limits.conf
  echo "* hard nofile 128000" >>/etc/security/limits.conf
  echo "* soft nproc 128000"  >>/etc/security/limits.conf
  echo "* hard nproc 128000"  >>/etc/security/limits.conf
  sed -i 's/1024/unlimited/' /etc/security/limits.d/20-nproc.conf
  ulimit -SHn 128000
  ulimit -SHu 128000
  ```

- 重启

# 搭建NTP时间服务器

  *此功能操作需要在主服务器及从服务器同时执行*

参考：

[https://oolong0616.github.io/2019/06/25/Centos%E5%AE%89%E8%A3%85%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%99%A8/](https://oolong0616.github.io/2019/06/25/Centos安装时间同步服务器/)

# SSH 免密登录

 *此功能操作需要在主服务器及从服务器分别执行*

- 主节点：生成rsa公钥

  ```bahs
  cd /root/.ssh
  ssh-keygen -t rsa
  ```

- 主节点：将公钥（id_rsa.pub）复制到从节点

  ```bash
  scp id_rsa.pub root@node1:/root/.ssh/authorized_keys_from_CDH1
  scp id_rsa.pub root@node2:/root/.ssh/authorized_keys_from_CDH1
  ```

- 在从节点上合并密钥

  ```bash
  cd /root/.ssh
  cat authorized_keys_from_CDH1 >> authorized_keys
  ```

- 验证：在主节点上免密登录Node1

  ```bash
  ssh root@node1
  ```

# 安装HTTP服务

*此功能操作需要在主服务器执行*

```bash
yum -y install httpd # 安装httpd服务
systemctl start httpd.service # 启动服务
systemctl enable httpd # 设置后台启动
systemctl status httpd.service # 查看状态
```

# 创建并初始化数据库&

*此功能操作需要在主服务器执行*

```sql
create database oozie  DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
create database hive DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
create database sentry DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
create database monitor DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
create database metastore DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
create database amon DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
create database hue DEFAULT CHARSET utf8 COLLATE utf8_general_ci;
```

# 解压及准备文件

*此功能操作需要在主服务器及从服务器分别执行*

- 解压并拷贝文件

  ```bash
  tar -xvf cloudera-manager-centos7-cm5.16.2_x86_64.tar.gz -C /opt
  cp CDH-5.16.2-1.cdh5.16.2.p0.8-el7.parcel /opt/cloudera/parcel-repo/
  cp CDH-5.16.2-1.cdh5.16.2.p0.8-el7.parcel.sha /opt/cloudera/parcel-repo/
  cp manifest.json /opt/cloudera/parcel-repo/
  ```

- 拷贝MysqlConnector到指定位置

  ```bash
  tar -xvf mysqlXXXX.tar.gz
  mv mysql-connector-java-5.1.47.jar mysql-connector-java.jar
  mkdir /usr/share/java
  cp mysql-connector-java.jar /usr/share/java/
  cp mysql-connector-java.jar /opt/cm-5.16.2/lib
  ```

# 配置文件修改

*此功能操作需要在主服务器及从服务器分别执行*

- 修改配置文件

  - 位置：/opt/cm-5.16.2/etc/cloudera-scm-agent/config.ini

  - 内容：

    ```bash
    # server_host=localhost
    server_host=node0.knowersoft.com
    ```

# 创建用户

此功能操作需要在主服务器及从服务器分别执行

```bash
useradd -r -d /opt/cm-5.16.2/run/cloudera-scm-server/ -M -s /bin/false -c "Cloudera SCM User" cloudera-scm
```

# 创建文件夹

*此功能操作需要在主服务器执行*

```bash
# 1
mkdir -p /var/lib/cloudera-scm-headlamp
mkdir -p /var/lib/cloudera-scm-firehose
mkdir -p /var/lib/cloudera-scm-alertpublisher
mkdir -p /var/lib/cloudera-scm-eventserver
mkdir -p /var/lib/cloudera-scm-server
mkdir -p /var/lib/cloudera-service-monitor
mkdir -p /var/lib/cloudera-host-monitor
mkdir -p /var/lib/cloudera-scm-navigator
# 2
mkdir -p /var/log/cloudera-scm-headlamp
mkdir -p /var/log/cloudera-scm-firehose
mkdir -p /var/log/cloudera-scm-alertpublisher
mkdir -p /var/log/cloudera-scm-eventserver
mkdir -p /var/log/cloudera-scm-server
mkdir -p /var/log/cloudera-service-monitor
mkdir -p /var/log/cloudera-host-monitor
mkdir -p /var/log/cloudera-scm-navigator
# 3
mkdir -p /opt/cloudera-manager
mkdir -p /opt/cloudera/parcels
mkdir /hbase
mkdir -p /user/hive/warehouse
# 4
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-headlamp
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-firehose
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-alertpublisher
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-eventserver
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-server
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-service-monitor
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-host-monitor
chown -R cloudera-scm:cloudera-scm /var/lib/cloudera-scm-navigator
# 5
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-scm-headlamp
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-scm-firehose
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-scm-alertpublisher
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-scm-eventserver
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-scm-server
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-service-monitor
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-host-monitor
chown -R cloudera-scm:cloudera-scm /var/log/cloudera-scm-navigator
# 6
chown -R cloudera-scm:cloudera-scm /opt/cloudera-manager
chown -R cloudera-scm:cloudera-scm /hbase
chown -R cloudera-scm:cloudera-scm /user/hive/warehouse
chown -R cloudera-scm:cloudera-scm /opt/cloudera/parcels
# 7
chown -R root:root /opt/cloudera/parcel-repo
# 8
chown cloudera-scm:cloudera-scm /opt/cloudera
chown cloudera-scm:cloudera-scm /opt/cm-5.16.2
```

*此功能操作需要在从服务器执行*

```bash
chown cloudera-scm:cloudera-scm /opt/cloudera
chown cloudera-scm:cloudera-scm /opt/cm-5.16.2
mkdir -p /opt/cloudera/parcels
chown -R cloudera-scm:cloudera-scm /opt/cloudera/parcels
```

# 配置数据库

*此功能操作需要在主服务器执行*

```sql
grant all privileges on *.* to 'root'@'localhost' identified by '1qaz2WSX' with grant option;
grant all privileges on *.* to 'root'@'node0' identified by '1qaz2WSX' with grant option;
grant all privileges on *.* to 'root'@'127.0.0.1' identified by '1qaz2WSX' with grant option;
grant all privileges on *.* to 'root'@'%' identified by '1qaz2WSX' with grant option;
flush privileges; 
```

# 开放端口

*此功能操作需要在主服务器及从服务器分别执行*

需要打开 7182\9001\9000 端口

# 初始化

```bash
/opt/cm-5.16.2/share/cmf/schema/scm_prepare_database.sh mysql cm -h localhost -uroot -p1qaz2WSX --scm-host localhost scm scm scm
# 说明：这个脚本就是用来创建和配置CMS需要的数据库的脚本。各参数是指：
#  mysql：数据库用的是mysql，如果安装过程中用的oracle，那么该参数就应该改为oracle。
#  -h localhost：数据库建立在hadoop1主机上面。也就是主节点上面。
#  -uroot：root身份运行mysql。-123456：mysql的root密码是***。
#  --scm-host hadoop1：CMS的主机，一般是和mysql安装的主机是在同一个主机上。
#  最后三个参数是：数据库名，数据库用户名，数据库密码。
```

# 启动

  - 主节点：

    ```bash
    /opt/cm-5.16.2/etc/init.d/cloudera-scm-server start 
    /opt/cm-5.16.2/etc/init.d/cloudera-scm-agent start
    ```
    
  - 从节点

    ```bash
    
    /opt/cm-5.16.2/etc/init.d/cloudera-scm-agent start
    ```
    

# 加入CDH源

此功能操作需要在主服务器及从服务器分别执行

我也不知道为啥要加这个，如果不加，会报错误如下*

```bash
http://mirrors.cloud.aliyuncs.com/centos/7/os/x86_64/repodata/repomd.xml: [Errno 14] HTTP Error 404 - Not Found
```

- 加入CDH源

```bash
cd /etc/yum.repos.d/
wget http://archive.cloudera.com/cm5/redhat/7/x86_64/cm/cloudera-manager.repo
wget https://archive.cloudera.com/cdh5/redhat/7/x86_64/cdh/cloudera-cdh5.repo
```

*注意版本号*

- 修改yum源, 配置cdh的版本

  - CDH：

    - 位置：/etc/yum.repos.d/cloudera-cdh5.repo

    - 内容：

      ```bash
      baseurl=https://archive.cloudera.com/cdh5/redhat/7/x86_64/cdh/5.X.X/(改成当前版本)
      ```

  - CM

    - 位置：/etc/yum.repos.d/cloudera-manager.repo

    - 内容：

      ```bash
      baseurl = https://archive.cloudera.com/cm5/redhat/7/x86_64/cm/5.X.X/(改成当前版本)
      ```

# CM 界面操作

- 地址：http://XXXX（Node0地址）:7180/cmf/login
- 用户名\密码：admin\admin

## 授权协议

![image-20190722162629961](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190722162629961.png)

## 版本选择 

![image-20190722162753546](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190722162753546.png)

![image-20190722162831033](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190722162831033.png)

## 搜索主机

![image-20190725154936673](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190725154936673.png)

![image-20190725155008548](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190725155008548.png)

## 集群安装

![image-20190722163412806](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190722163412806.png)

![image-20190722163532178](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190722163532178.png)

选择单用户模式（单用户还是有问题）

![image-20190722165720809](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190722165720809.png)

![image-20190722163815334](/MyDoc/05_WorkSpace/oolong0616.github.io/img/image-20190722163815334.png)

# 错误处理 

1. 问题1
   
   
   1. 有时候安装cloudera会报socket.gaierror: [Errno -2] Name or service not known，或者服务器可能IP或mac地址冲突会引发次错误。导致机器服务不能正常运行和重装。
   2. 删除/usr/bin/host文件即可解决问题
   
2. 问题2

   1. 如果提示：

      ```could not contact scm server at ecs-114-115-232-32.compute.hwclouds-dns.com:7182, giving up waiting for rollback request``` 
      
   2. 则需要将ecs-114-115-232-32.compute.hwclouds-dns.com在hosts上映射IP



